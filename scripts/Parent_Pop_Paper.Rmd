---
title: "Phenology_Models"
output: html_document
date: "2025-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyverse)
library(lubridate)
library(lme4)
library(bbmle)
library(googlesheets4)
library(lmtest)
library(car)
library(lmerTest)
```

```{r}
#Input Cleaned Common Garden Data
UCD22_23 <- read_csv("../input/UCD22_23_transplant.csv")
WL2_23 <- read_csv("../input/WL2_23.csv")
WL2_24 <- read_csv("../input/WL2_24.csv")

#Input Climate Distance Data
clim_dist_UCD22_23 <- read_csv("../input/growthseason_GowersEnvtalDist_UCD.csv")
wtr_year_UCD <- read_csv("../input/full_year_GowersEnvtalDist_UCD_wtr_year.csv")
clim_dist_WL2_23 <- read_csv("../input/growthseason_GowersEnvtalDist_WL2.csv")
wtr_year_WL2_23 <- read_csv("../input/full_year_GowersEnvtalDist_WL2_wtr_year.csv")
both_clim_dist_WL2_24 <- read_csv("../input/Gowers_WL2_2024.csv")

#Input Fitness Data
UCD_fruit <- read_csv("../input/UCD_Fruits.csv")
WL2_24_fruit <- read_csv("../input/WL2_Fruits_Y2.csv")
WL2_23_fruit <- read_csv("../input/WL2_Fruits_Y1.csv")
WL2_24_frt_prob <- read_csv("../input/WL2_ProbFruits_Y2.csv")
UCD_frt_prob <- read_csv("../input/ProbFruits_UCD.csv")
WL2_prob_fit <- read_csv("../input/WL2_ProbFitness.csv")
WL2_total_fit <- read_csv("../input/WL2_TotalRepOutput.csv")
```

### Setting up data frame

#### Select only the columns of interest and only parent pops from the WL2_24 garden

```{r}
UCD22_23 <- UCD22_23 %>%
  mutate(bed = str_extract(block, "^[A-Za-z]")) %>% #create column for bed by extracting info from block column
  select(block, bed, row, col, everything()) %>% #reorder columns
  select(block, bed, row, col, pop, mf, rep, bud.date_dt, flower.date_dt, fruit.date_dt, last.FL.date_dt, last.FR.date_dt, death.date_dt) %>% #select columns of interest
  filter(pop != "buffer") #filter out buffer plants

WL2_23 <- WL2_23 %>%
  select(block, bed, row, col, pop, mf, rep, bud.date_dt, flower.date_dt, fruit.date_dt, last.FL.date_dt, last.FR.date_dt, death.date_dt) %>%
  filter(grepl("^\\d+$", rep)) #removes buffer plants and empty spaces

WL2_24 <- WL2_24 %>%
  select(bed, row, col, pop, mf, rep, bud.date_dt, flower.date_dt, fruit.date_dt, last.FL.date_dt, last.FR.date_dt, death.date_dt) %>%
  left_join(WL2_23 %>% select(block, bed, row, col), by=c("bed", "row", "col")) %>% #add block info using WL2_23 block column
  select(block, bed, row, col, everything()) #reorder columns 
```

#### Combine all gardens into one tibble, add site and year columns

```{r}
parent_pheno <- bind_rows(
  UCD22_23 %>% mutate(site="UCD_23"),
  WL2_23 %>% mutate(site="WL2_23"),
  WL2_24 %>% mutate(site="WL2_24")
)

parent_pheno <- parent_pheno %>%
  separate(site, into = c("site", "year"), sep = "_")
```

#### Add elevation and latitude data

```{r}
both_clim_dist_WL2_24 <- both_clim_dist_WL2_24 %>%
  filter(TimePd == "Recent") %>%
  rename(pop=parent.pop)

parent_pheno <- parent_pheno %>%
  left_join(both_clim_dist_WL2_24 %>% select(pop, elev_m, Lat), by="pop")
```

#### Add recent climate distance - could have also added climate distance from fitness data csv

```{r}
clim_dist_UCD22_23 <- clim_dist_UCD22_23 %>%
  filter(TimePd == "Recent") %>%
  rename(pop=parent.pop) %>%
  rename(GrwSsn_GD=Gowers_Dist) %>%
  mutate(site="UCD")

wtr_year_UCD <- wtr_year_UCD %>%
  filter(TimePd == "Recent") %>%
  rename(pop=parent.pop) %>%
  rename(Wtr_Year_GD=Gowers_Dist) %>%
  mutate(site="UCD")

clim_dist_WL2_23 <- clim_dist_WL2_23 %>%
  filter(TimePd == "Recent") %>%
  rename(pop=parent.pop) %>% 
  rename(GrwSsn_GD=Gowers_Dist) %>%
  mutate(site = "WL2") %>%
  mutate(year= 23)

wtr_year_WL2_23 <- wtr_year_WL2_23 %>%
  filter(TimePd == "Recent") %>%
  rename(pop=parent.pop) %>%
  rename(Wtr_Year_GD=Gowers_Dist) %>%
  mutate(site = "WL2") %>%
  mutate(year=23)

both_clim_dist_WL2_24 <- both_clim_dist_WL2_24 %>%
  mutate(site = "WL2") %>%
  mutate(year = 24)

parent_pheno <- parent_pheno %>%
  mutate(year = as.numeric(year)) %>%
  left_join(clim_dist_UCD22_23 %>% select(pop, GrwSsn_GD, site), by = c("pop", "site")) %>%
  left_join(wtr_year_UCD %>% select(pop, Wtr_Year_GD, site), by = c("pop", "site")) %>%
  left_join(clim_dist_WL2_23 %>% select(pop, GrwSsn_GD, site, year), by = c("pop", "site", "year")) %>%
  left_join(wtr_year_WL2_23 %>% select(pop, Wtr_Year_GD, site, year), by = c("pop", "site", "year")) %>%
  left_join(both_clim_dist_WL2_24 %>% select(pop, site, year, GrwSsn_GD, Wtr_Year_GD), by = c("pop", "site", "year")) %>%
  mutate(
    Grw_Ssn_GD = coalesce(GrwSsn_GD.x, GrwSsn_GD.y, GrwSsn_GD),
    Wtr_Yr_GD = coalesce(Wtr_Year_GD.x, Wtr_Year_GD.y, Wtr_Year_GD)
  ) %>%
  select(-GrwSsn_GD.x, -GrwSsn_GD.y, -GrwSsn_GD, -Wtr_Year_GD.x, -Wtr_Year_GD.y, -Wtr_Year_GD)

```

#### Add fitness data

```{r}
#number of fruits made by each indiv at UCD
UCD_fruit <- UCD_fruit %>%
  mutate(site="UCD")

#prob making a fruit in year 1 at UCD given survival to bolting
UCD_frt_prob <- UCD_frt_prob %>%
  mutate(site = "UCD") %>%
  rename(UCD_Y1_Prob_Fruits=ProbFruits)

#number of fruits made at WL2 in 2023
WL2_23_fruit <- WL2_23_fruit %>%
  mutate(site="WL2") %>%
  mutate(year=23) %>%
  rename(row='bed-row') %>%
  rename(col='bed-col')

#number of fruits made at WL2 in 2024
WL2_24_fruit <- WL2_24_fruit %>%
  mutate(site="WL2") %>%
  mutate(year=24) 

#prob making a fruit in year 2 at WL2 (given the indiv survived to bolting)
WL2_24_frt_prob <- WL2_24_frt_prob %>%
  mutate(site="WL2") %>%
  mutate(year=24) %>%
  rename(WL2_Y2_Prob_Fruits=ProbFruits)

#prob of successfully reproducing - prob of making at least 1 fruit in year 1 or 2 at WL2
WL2_prob_fit <- WL2_prob_fit %>%
  rename(row=bed.row) %>%
  rename(col=bed.col) %>%
  rename(WL2_ProbFitness=ProbFitness) %>%
  mutate(site="WL2")
  
#Total repro output - total fruit number across both years at WL2
WL2_total_fit <- WL2_total_fit %>%
  rename(row=bed.row) %>%
  rename(col=bed.col) %>%
  rename(WL2_Total_Fitness=Total_Fitness) %>%
  rename(log_WL2_Total_Fitness=logTotalFitness) %>%
  mutate(site="WL2")

parent_pheno <- parent_pheno %>%
  left_join(UCD_fruit %>% select(block, row, col, site, fruits, FrFlN), by=c("block", "row", "col", "site")) %>%
  left_join(UCD_frt_prob %>% select(block, row, col, site, UCD_Y1_Prob_Fruits), by=c("block", "row", "col", "site")) %>%
  left_join(WL2_23_fruit %>% select(bed, row, col, site, year, fruits, FrFlN), by=c("bed", "row", "col", "year", "site")) %>%
  left_join(WL2_24_fruit %>% select(bed, row, col, site, year, fruits, FrFlN), by=c("bed", "row", "col", "year", "site")) %>%
  left_join(WL2_24_frt_prob %>% select(bed, row, col, site, year, WL2_Y2_Prob_Fruits), by=c("bed", "row", "col", "year", "site")) %>%
  left_join(WL2_prob_fit %>% select(bed, row, col, site, WL2_ProbFitness), by=c("bed", "row", "col", "site")) %>%
  left_join(WL2_total_fit %>% select(bed, row, col, site, WL2_Total_Fitness, log_WL2_Total_Fitness), by=c("bed", "row", "col", "site")) %>%
  mutate(
    Fruits = coalesce(fruits.x, fruits.y, fruits),
    FrFlw = coalesce(FrFlN.x, FrFlN.y, FrFlN)
  ) %>%
  select(-fruits.x, -fruits.y, -fruits, -FrFlN.x, -FrFlN.y, -FrFlN)
  #at UCD some rows have a 0 for ProbFruits but nothing for fruit and/or frflw and also the opposite - do I need to make sure if there is a 0 in ProbFruits that there is also a 0 in fruits
  #there are some cases where the plant has 0 fruits but the probability of making fruits is NA and not 0 because the plant might have still been alive by the last survey but not yet produced any fruits - what do I do here?
#this is because ProbFruits was the probabiliyt of making a fruit given survival to bolting so individuals that were still alive but didn't initiate reproduction by the last survey had a fruit count of 0 but were not included in the ProbFruits calc.
```

#### Calculate duration of each reproductive stage and add binary column for initiating reproduction

```{r}
#Bud duration (flower.date - bud.date)
#Flower duration (last.FL.date - flower.date)
#Fruit duration (last.FR.date - fruit.date)
#Total repro duration (last.FR.date - bud.date)
#Initiate repro(1 if there is any repro date, 0 if no repro date)
  # I would want to use bud.date to determine if a plant initiated repro, but we missed the bud date for some plants

parent_pheno <- parent_pheno %>%
  mutate(bud.duration = as.numeric(flower.date_dt - bud.date_dt)) %>%
  mutate(flower.duration = as.numeric(last.FL.date_dt - flower.date_dt)) %>%
  mutate(fruit.duration = as.numeric(last.FR.date_dt - fruit.date_dt)) %>%
  mutate(total.repro.duration = as.numeric(last.FR.date_dt - bud.date_dt)) %>%
  mutate(initiate.repro = if_else(
      !is.na(bud.date_dt) | !is.na(flower.date_dt) | 
      !is.na(fruit.date_dt) | !is.na(last.FR.date_dt) | 
      !is.na(last.FL.date_dt), 
      1, 0
    ))

write.csv(parent_pheno, "../input/parent_pheno.csv")
```

#### Visualizing each repro duration across sites

```{r}
parent_pheno %>%
  filter(!is.na(bud.duration)) %>%
  filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=bud.duration, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(flower.duration)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=flower.duration, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(fruit.duration)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=fruit.duration, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(total.repro.duration)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=total.repro.duration, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)
```

#### Visualize days to each repro stage

```{r}
parent_pheno %>%
  filter(!is.na(bud.date_dt)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR", "YO7", "IH"))) %>%
  ggplot(aes(x=bud.date_dt, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop) #ALL YO7 budded on the same date  at WL2, All WL2 budded on the same date at WL2 (only 1 WL2 reproduced at UCD), TM2 flowering at UCD is very syncronous

parent_pheno %>%
  filter(!is.na(flower.date_dt)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=flower.date_dt, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(fruit.date_dt)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=fruit.date_dt, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(last.FL.date_dt)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=last.FL.date_dt, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)

parent_pheno %>%
  filter(!is.na(last.FR.date_dt)) %>%
  #filter(!(pop %in% c("CP2", "SQ1", "SQ3", "WR"))) %>%
  ggplot(aes(x=last.FR.date_dt, fill=site)) +
  geom_boxplot() +
  facet_wrap(~pop)


```

#### Model: Does initiating reproduction differ by site/elevation?

```{r}
#THERE IS A CONVERGENCE ISSUE WITH A SITE*ELEV interaction, so split up the two

#Does initiating reproduction differ by site with pop as a random effect
initiate_site <- glmer(initiate.repro ~ site + (1|pop),
                  data=parent_pheno,
                  family = binomial())

summary(initiate_site)
Anova(initiate_site)

#Does initiating reproduction differ by elevation?
initiate_elev_pop <- glmer(initiate.repro ~ elev_m + (1|pop),
                       data=parent_pheno,
                       family=binomial()) #THERE IS A CONVERGENCE ERROR WITH POP AS A RANDOM EFFECT
summary(initiate_elev_pop)


initiate_elev <- glm(initiate.repro ~ elev_m, 
                     data= parent_pheno,
                     family=binomial()) #GLM WITH ONLY ELEV AS PREDICTOR
initiate_elev_null <- glm(initiate.repro ~ 1,
                          data=parent_pheno,
                          family=binomial())
lrtest(initiate_elev_null, initiate_elev)
summary(initiate_elev)
```

```{r}
#filter to only include individuals that initiated reproduction
init.repro <- parent_pheno %>%
  filter(initiate.repro == 1)

write.csv(init.repro, "../input/init.repro.csv")

```

```{r}
#ggplot(init.repro, aes(x=site, y=total.repro.duration, color=elev_m)) +
 # geom_point() +
 # geom_smooth(method="lm", aes(group=elev_m))

#ggplot(init.repro, aes(x=site, y=bud.duration, color=elev_m)) +
 # geom_point() +
  #geom_smooth(method="lm", aes(group=elev_m))

#ggplot(init.repro, aes(x=site, y=flower.duration, color=elev_m)) +
 # geom_point() +
  #geom_smooth(method="lm", aes(group=elev_m))

#ggplot(init.repro, aes(x=site, y=fruit.duration, color=elev_m)) +
 # geom_point() +
  #geom_smooth(method="lm", aes(group=elev_m))

```

#### Rx norms for total repro duration and bud duration - only BH and TM2

```{r}
#repro_summary %>%
 # filter(N_repro != 1) %>%
  #ggplot(aes(x=site, y=mean_total_dur, group=pop, color=elev_m)) +
  #geom_point(size=1.5) +
  #geom_line(size=1) +
  #geom_errorbar(aes(ymin=mean_total_dur-sem_total_dur, ymax=mean_total_dur+sem_total_dur), width=0.1) 

#repro_summary %>%
 # filter(N_bud != 1) %>%
  #ggplot(aes(x=site, y=mean_bud_dur, group=pop, color=elev_m)) +
  #geom_point(size=1.5) +
  #geom_line(size=1) +
  #geom_errorbar(aes(ymin=mean_bud_dur-sem_bud_dur, ymax=mean_bud_dur+sem_bud_dur), width=0.1) 
```




```{r}
#dt_flw_summary <- init.repro %>%
 # group_by(pop, site, elev_m) %>%
 # summarize(N_flw = sum(!is.na(flower.date_dt)),
  #          mean_dt_flw = mean(flower.date_dt, na.rm=(TRUE)),
   #         sem_dt_flw = sem(flower.date_dt, na.rm=(TRUE))
   #         )

#dt_flw_summary %>%
 ## filter(N_flw != 1) %>%
 # ggplot(aes(x=site, y=mean_dt_flw, group=pop, color=elev_m)) +
 # geom_point(size=1.5) +
 # geom_line(size=1) +
 # geom_errorbar(aes(ymin=mean_dt_flw-sem_dt_flw, ymax=mean_dt_flw+sem_dt_flw), width=0.1) +
 # scale_colour_gradient(low = "#F5A540", high = "#0043F0")

```

```{r}
#dt_fr_summary <- init.repro %>%
#  group_by(pop, site, elev_m) %>%
 # summarize(N_fr = sum(!is.na(fruit.date_dt)),
    #        mean_dt_fr = mean(fruit.date_dt, na.rm=(TRUE)),
    #        sem_dt_fr = sem(fruit.date_dt, na.rm=(TRUE))
    #        )

#dt_fr_summary %>%
#  filter(N_fr != 1) %>%
 # ggplot(aes(x=site, y=mean_dt_fr, group=pop, color=elev_m)) +
 # geom_point(size=1.5) +
 # geom_line(size=1) +
 # geom_errorbar(aes(ymin=mean_dt_fr-sem_dt_fr, ymax=mean_dt_fr+sem_dt_fr), width=0.1) +
 # scale_colour_gradient(low = "#F5A540", high = "#0043F0")
```


#### Does flowering duration differ by pop at WL2?

```{r}
WL2_24_flw_dur <- init.repro %>%
  filter(site == "WL2") %>%
  filter(year == 24) %>%
  filter(!(is.na(flower.duration))) %>%
  filter(pop %in% c("BH", "CC", "IH", "SC", "TM2", "WL2", "YO7")) %>%
  left_join(both_clim_dist_WL2_24 %>% select(pop, GrwSsn_GD, Wtr_Year_GD), by="pop")

ggplot(WL2_24_flw_dur, aes(x=flower.duration))+
  geom_boxplot()+
  facet_wrap(~pop)

WL2_flw_dur_elev <- lmer(flower.duration ~ elev_m + (1|pop),
                    data = WL2_24_flw_dur) #singularity warning
summary(WL2_flw_dur_elev)
Anova(WL2_flw_dur_elev) #marginally significant

WL2_flw_dur_lat <- lmer(flower.duration ~ Lat + (1|pop),
                        data=WL2_24_flw_dur)
summary(WL2_flw_dur_lat)
Anova(WL2_flw_dur_lat) #not significant


#Testing climate distance - not significant for either
WL2_flw_dur_grw_ssn <- lmer(flower.duration ~ GrwSsn_GD + (1|pop),
                            data=WL2_24_flw_dur)
summary(WL2_flw_dur_grw_ssn)
Anova(WL2_flw_dur_grw_ssn)

WL2_flw_dur_wtr_year <- lmer(flower.duration ~ Wtr_Year_GD + (1|pop),
                            data=WL2_24_flw_dur)
summary(WL2_flw_dur_wtr_year)
Anova(WL2_flw_dur_wtr_year)
```

#### Does fruiting duration differ by pop at WL2?

```{r}
WL2_24_fr_dur <- init.repro %>%
  filter(site == "WL2") %>%
  filter(year == 24) %>%
  filter(!(is.na(fruit.duration))) %>%
  filter(pop %in% c("BH", "CC", "IH", "SC", "TM2", "WL2", "YO7")) %>%
  left_join(both_clim_dist_WL2_24 %>% select(pop, GrwSsn_GD, Wtr_Year_GD), by="pop")

ggplot(WL2_24_fr_dur, aes(x=fruit.duration))+
  geom_boxplot()+
  facet_wrap(~pop)

WL2_fr_dur_elev <- lmer(fruit.duration ~ elev_m + (1|pop),
                    data = WL2_24_fr_dur)
summary(WL2_fr_dur_elev)
Anova(WL2_fr_dur_elev) 

WL2_fr_dur_lat <- lmer(fruit.duration ~ Lat + (1|pop),
                        data=WL2_24_fr_dur)
summary(WL2_fr_dur_lat)
Anova(WL2_fr_dur_lat) #neither elevation nor lat is significant


#Testing climate distance - not significant for either
WL2_fr_dur_grw_ssn <- lmer(fruit.duration ~ GrwSsn_GD + (1|pop),
                            data=WL2_24_fr_dur)
summary(WL2_fr_dur_grw_ssn)
Anova(WL2_fr_dur_grw_ssn)

WL2_fr_dur_wtr_year <- lmer(fruit.duration ~ Wtr_Year_GD + (1|pop),
                            data=WL2_24_fr_dur)
summary(WL2_fr_dur_wtr_year)
Anova(WL2_fr_dur_wtr_year)
```


#### Bud duration and timing at UCD and number of fruits/FrFlN

```{r}
#1) include 0's but not NA's 
#2) exclude NA's but use FrFlN - compare the fruit model to FrFlN model

UCD_bud_fruit <- UCD_bud_fruit %>%
  filter(!(is.na(fruits))) %>%
  #filter(fruits > 0) %>% #do we wannt to do this?
  filter(!(is.na(bud.duration)))%>%
  filter(pop != "SC")

ggplot(UCD_bud_fruit, aes(x=bud.duration, y=fruits, color=pop))+
  geom_point() #visually, generally the longer the bud duration, the more fruit but this is driven by TM2

UCD_bud_dur_fruit <- lmer(fruits ~ bud.duration + (1|pop),
                          data=UCD_bud_fruit) #only TM2, DPR (although only 2 indiv) and BH in the model but multiple individuals from both (removed SC with only 1 individual that produced fruit)
summary(UCD_bud_dur_fruit)
Anova(UCD_bud_dur_fruit) #Significant relationship between bud duration and fruit number

#Testing fruit and flower number
UCD_bud_dur_FrFlN <- lmer(FrFlN ~ bud.duration + (1|pop),
                          data=UCD_bud_fruit)
summary(UCD_bud_dur_FrFlN)
Anova(UCD_bud_dur_FrFlN)

UCD_dt_bud_fruit <- UCD_dt_bud %>%
  left_join(UCD_fruit %>% select(block, row, col, fruits, FrFlN), by=c("block", "row", "col")) 

UCD_dt_bud_fruit <- UCD_dt_bud_fruit%>%
  filter(!(is.na(bud.date_dt))) %>%
  filter(!(is.na(fruits)))
  #filter(fruits > 0)
  
ggplot(UCD_dt_bud_fruit, aes(x=bud.date_dt, y=fruits, color=pop)) +
  geom_point()

UCD_bud_dt_fruit <- lmer(fruits ~ bud.date_dt + (1|pop),
                          data=UCD_dt_bud_fruit) 
summary(UCD_bud_dt_fruit)
Anova(UCD_bud_dt_fruit) 

#Testing fruit and flower number
UCD_bud_dt_FrFlN <- lmer(FrFlN ~ bud.date_dt + (1|pop),
                          data=UCD_dt_bud_fruit) 
summary(UCD_bud_dt_FrFlN)
Anova(UCD_bud_dt_FrFlN) 
```

#### Bud duration and fruit/FrFlN at WL2

```{r}

WL2_bud_fit <- init.repro %>%
  filter(site == "WL2") %>%
  left_join(WL2_24_fruit %>% select(bed, row, col, fruits, FrFlN), by=c("bed", "row", "col")) %>%
  left_join(WL2_23_fruit %>% select(bed, row, col, fruits, FrFlN), by=c("bed", "row", "col")) %>%
  mutate(
    fruits = coalesce(fruits.x, fruits.y),  # Combine fruits from both years
    FrFlN = coalesce(FrFlN.x, FrFlN.y)    # Combine FrFlN from both years
  ) %>%
  select(-fruits.x, -fruits.y, -FrFlN.x, -FrFlN.y) 

WL2_bud_dur_fit <- WL2_bud_fit %>%
  filter(!(is.na(bud.duration))) %>%
  filter(!(is.na(fruits)))

ggplot(WL2_bud_dur_fit, aes(x=bud.duration, y=fruits, color=pop))+
  geom_point()

WL2_bud_dur_fruit <- lmer(fruits ~ bud.duration + (1|pop),
                          data=WL2_bud_dur_fit)
summary(WL2_bud_dur_fruit) #marginally negative relationship between bud duration and fruit number
Anova(WL2_bud_dur_fruit)



WL2_dt_bud_fruit <- WL2_bud_fit %>%
  filter(!(is.na(bud.date_dt))) %>%
  filter(!(is.na(fruits)))
  
ggplot(WL2_dt_bud_fruit, aes(x=bud.date_dt, y=fruits, color=pop)) +
  geom_point()

WL2_bud_dt_fruit <- lmer(fruits ~ bud.date_dt + (1|pop),
                          data=WL2_dt_bud_fruit) 
summary(WL2_bud_dt_fruit)
Anova(WL2_bud_dt_fruit) 



#testing with FrFlN
WL2_bud_dur_FrFl <- WL2_bud_fit %>%
  filter(!(is.na(bud.duration))) %>%
  filter(!(is.na(FrFlN)))

ggplot(WL2_bud_dur_FrFl, aes(x=bud.duration, y=FrFlN, color=pop))+
  geom_point()

WL2_bud_dur_FrFlN <- lmer(fruits ~ bud.duration + (1|pop),
                          data=WL2_bud_dur_FrFl)
summary(WL2_bud_dur_FrFlN) #marginally negative relationship between bud duration and fruit number
Anova(WL2_bud_dur_FrFlN)


WL2_dt_bud_FrFl <- WL2_bud_fit %>%
  filter(!(is.na(bud.date_dt))) %>%
  filter(!(is.na(FrFlN)))

ggplot(WL2_dt_bud_FrFl, aes(x=bud.date_dt, y=fruits, color=pop)) +
  geom_point()

WL2_bud_dt_FrFlN <- lmer(fruits ~ bud.date_dt + (1|pop),
                          data=WL2_dt_bud_FrFl) 
summary(WL2_bud_dt_FrFlN)
Anova(WL2_bud_dt_FrFlN) 
```

#### Bud duration and timing and survival to make a fruit at WL2

```{r}


WL2_bud_dur_frt_prob <- init.repro %>%
  filter(site == "WL2") %>%
  filter(year == 24) %>%
  filter(!(is.na(bud.duration))) %>%
  filter(pop %in% c("BH", "CC", "IH", "SC", "TM2", "WL2", "YO7")) %>%
  left_join(WL2_24_frt_prob %>% select(bed, row, col, ProbFruits), by=c("bed", "row", "col"))
  
ggplot(WL2_bud_dur_frt_prob, aes(x=bud.duration, y=ProbFruits, color=pop)) +
  geom_jitter(height=0.01)

WL2_24_bud_dur_prob_fruit <- glmer(ProbFruits ~ bud.duration + (1|pop),
                                   data=WL2_bud_dur_frt_prob,
                                   family=binomial)
summary(WL2_24_bud_dur_prob_fruit)
Anova(WL2_24_bud_dur_prob_fruit)

#could calculate mean prob of making fruit and mean bud duration for each pop - but lose indiv variation
WL2_bud_dur_mean_frt_prob <- WL2_bud_dt_frt_prob %>%
  group_by(pop) %>%
  summarize(mean_frt_prob = mean(ProbFruits, na.rm=TRUE),
            sem_frt_prob = sem(ProbFruits, na.rm=TRUE),
            mean_bud_dur = mean(bud.duration, na.rm=TRUE),
            sem_bud_dur= sem(bud.duration, na.rm=TRUE)) %>%
  ungroup()

ggplot(WL2_bud_dur_mean_frt_prob, aes(x=mean_bud_dur, y=mean_frt_prob, color=pop))+
  geom_point()

mean_frt_prob_reg <- glm(mean_frt_prob ~ mean_bud_dur,
                         family=gaussian(),
                         data= WL2_bud_dur_mean_frt_prob)
summary(mean_frt_prob_reg)
Anova(mean_frt_prob_reg)


WL2_bud_dt_frt_prob <- init.repro %>%
  filter(site == "WL2") %>%
  filter(year == 24) %>%
  filter(!(is.na(bud.date_dt))) %>%
  filter(!(pop %in% c("SQ1", "WR"))) %>%
  left_join(WL2_24_frt_prob %>% select(bed, row, col, ProbFruits), by=c("bed", "row", "col"))
  
ggplot(WL2_bud_dt_frt_prob, aes(x=bud.date_dt, y=ProbFruits, color=pop)) +
  geom_jitter(height=0.01)
  
WL2_24_bud_dt_prob_fruit <- glmer(ProbFruits ~ bud.date_dt + (1|pop),
                                   data=WL2_bud_dt_frt_prob,
                                   family=binomial)
summary(WL2_24_bud_dt_prob_fruit)
Anova(WL2_24_bud_dt_prob_fruit)
```

#### Bud duration and survival to make a fruit at UCD

```{r}

UCD_bud_dur_frt_prob <- init.repro %>%
  filter(site == "UCD") %>%
  filter(!(is.na(bud.duration))) %>%
  filter(pop %in% c("BH", "TM2")) %>%
  left_join(UCD_frt_prob %>% select(block, row, col, ProbFruits), by=c("block", "row", "col"))
  
ggplot(UCD_bud_dur_frt_prob, aes(x=bud.duration, y=ProbFruits, color=pop)) +
  geom_jitter(height=0.01)

UCD_bud_dur_prob_fruit <- glmer(ProbFruits ~ bud.duration + (1|pop),
                                   data=UCD_bud_dur_frt_prob,
                                   family=binomial)
summary(UCD_bud_dur_prob_fruit)
Anova(UCD_bud_dur_prob_fruit)


UCD_bud_dt_frt_prob <- init.repro %>%
  filter(site == "UCD") %>%
  filter(!(is.na(bud.date_dt))) %>%
  filter(!(pop %in% c("CP2", "FR", "SQ3", "WL2"))) %>%
  left_join(UCD_frt_prob %>% select(block, row, col, ProbFruits), by=c("block", "row", "col"))
  
ggplot(UCD_bud_dt_frt_prob, aes(x=bud.date_dt, y=ProbFruits, color=pop)) +
  geom_jitter(height=0.01)
  
UCD_bud_dt_prob_fruit <- glmer(ProbFruits ~ bud.duration + (1|pop),
                                   data=UCD_bud_dt_frt_prob,
                                   family=binomial)
summary(UCD_bud_dt_prob_fruit)
Anova(UCD_bud_dt_prob_fruit)
```

#### Both WL2 years and probability of successfully reproducing

```{r}


WL2_prob_fit <- WL2_prob_fit %>%
  rename(row=bed.row) %>%
  rename(col=bed.col)

all_WL2_fit_prob_bud_dur <- init.repro %>%
  filter(site == "WL2")  %>%
  filter(!(is.na(bud.duration))) %>%
  left_join(WL2_prob_fit %>% select(bed, row, col, ProbFitness), by=c("bed", "row", "col")) %>%
  filter(!(pop %in% c("SQ1", "WR")))

ggplot(all_WL2_fit_prob_bud_dur, aes(x=bud.duration, y=ProbFitness, color=pop)) +
  geom_jitter(height=0.01)

prob_fit_bud_dur <- glmer(ProbFitness ~ bud.duration + (1|pop),
                                   data=all_WL2_fit_prob_bud_dur,
                                   family=binomial)
summary(prob_fit_bud_dur)
Anova(prob_fit_bud_dur)
plogis(fixef(prob_fit_bud_dur)) #Back transforming/Inverse Logit of the fixed effect coefficients

all_WL2_fit_prob_dt_bud <- init.repro %>%
  filter(site == "WL2")  %>%
  filter(!(is.na(bud.date_dt))) %>%
  left_join(WL2_prob_fit %>% select(bed, row, col, ProbFitness), by=c("bed", "row", "col")) #%>%
  #filter(!(pop %in% c("SQ1", "WR")))

ggplot(all_WL2_fit_prob_dt_bud, aes(x=bud.date_dt, y=ProbFitness, color=pop)) +
  geom_jitter(height=0.01)

prob_fit_dt_bud <- glmer(ProbFitness ~ bud.date_dt + (1|pop),
                                   data=all_WL2_fit_prob_dt_bud,
                                   family=binomial)
summary(prob_fit_dt_bud)
Anova(prob_fit_dt_bud)
```

#### WL2 total fitness

```{r}


WL2_total_fit <- WL2_total_fit %>%
  rename(row=bed.row) %>%
  rename(col=bed.col)

WL2_total_fit_bud_dur <- init.repro %>%
  filter(site == "WL2") %>%
  left_join(WL2_total_fit %>% select(bed, row, col, Total_Fitness, logTotalFitness), by=c("bed", "row", "col")) %>%
  filter(!(is.na(Total_Fitness))) %>%
  filter(!(pop %in% c("SQ1", "WR")))

ggplot(WL2_total_fit_bud_dur, aes(x=bud.duration, y=Total_Fitness, color=pop)) +
  geom_point()

WL2_bud_dur_total_fit <- lmer(Total_Fitness ~ bud.duration + (1|pop),
                              data=WL2_total_fit_bud_dur)
summary(WL2_bud_dur_total_fit)
Anova(WL2_bud_dur_total_fit)


ggplot(WL2_total_fit_bud_dur, aes(x=bud.date_dt, y=Total_Fitness, color=pop)) +
  geom_point()

WL2_dt_bud_total_fit <- lmer(Total_Fitness ~ bud.date_dt + (1|pop),
                              data=WL2_total_fit_bud_dur)
summary(WL2_dt_bud_total_fit)
Anova(WL2_dt_bud_total_fit)
```

---
title: "Preliminary Data Exploration"
output:
  word_document: default
  html_document: default
date: "2024-10-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyverse)
library(lubridate)
library(lme4)
library(googlesheets4)
library(lmtest)
```

### UCD 2022-2023 Transplants

```{r}
UCD_pheno_transplant <- read_csv("../input/UCD_2023_Data/Phenology_survey_transplants_20230508_corrected.csv")
```

#### Renaming columns to remove spaces between words

```{r}
colnames(UCD_pheno_transplant)[colnames(UCD_pheno_transplant) == "Date First Bud"] <- "Date_First_Bud"
colnames(UCD_pheno_transplant)[colnames(UCD_pheno_transplant) == "Date First Fruit"] <- "Date_First_Fruit"
colnames(UCD_pheno_transplant)[colnames(UCD_pheno_transplant) == "Date First Flower"] <- "Date_First_Flower"
colnames(UCD_pheno_transplant)[colnames(UCD_pheno_transplant) == "Date Last Flower"] <- "Date_Last_Flower"
colnames(UCD_pheno_transplant)[colnames(UCD_pheno_transplant) == "Date Last Fruit"] <- "Date_Last_Fruit"

```

#### Apply lubridate

```{r}
UCD_pheno_transplant$Date_First_Bud <- mdy(UCD_pheno_transplant$Date_First_Bud)
UCD_pheno_transplant$Date_First_Flower <- mdy(UCD_pheno_transplant$Date_First_Flower)
UCD_pheno_transplant$Date_First_Fruit <- mdy(UCD_pheno_transplant$Date_First_Fruit)
UCD_pheno_transplant$Date_Last_Flower <- mdy(UCD_pheno_transplant$Date_Last_Flower) #no last flower dates
UCD_pheno_transplant$Date_Last_Fruit <- mdy(UCD_pheno_transplant$Date_Last_Fruit) #no last fruit dates
```

#### Filter to only include individuals that budded - don't know if I should use this

```{r}

#UCD_pheno_trans_filter <- UCD_pheno_transplant[!is.na(UCD_pheno_transplant$Date_First_Bud) | !is.na(UCD_pheno_transplant$Date_First_Flower), ]
```

#### Visualize bud date - the year for one individual is wrong

```{r}
ggplot(UCD_pheno_transplant, aes(x=Date_First_Bud)) +
  geom_histogram()
```

##### Identify which row has the wrong year

```{r}
# one first bud date seems to be 2022 which is not correct
bud2022 <- UCD_pheno_transplant[year(UCD_pheno_transplant$Date_First_Bud) == 2022,]
print(bud2022)
```

##### Update the year to 2023

```{r}
# Directly update the date of the 2022 entry
UCD_pheno_transplant[UCD_pheno_transplant$block == "L1" & 
                       UCD_pheno_transplant$row == 4 & 
                       UCD_pheno_transplant$col == "A", "Date_First_Bud"] <- 
  update(UCD_pheno_transplant[UCD_pheno_transplant$block == "L1" & 
                                UCD_pheno_transplant$row == 4 & 
                                UCD_pheno_transplant$col == "A", "Date_First_Bud"][[1]], 
         year = 2023)

# Verify the updated date
print(UCD_pheno_transplant[UCD_pheno_transplant$block == "L1" & 
                             UCD_pheno_transplant$row == 4 & 
                             UCD_pheno_transplant$col == "A", ])

```

#### Change date to days since planting

```{r}
UCD_pheno_transplant <- UCD_pheno_transplant %>%
  mutate(
    planting_date = mdy("11/27/2022")
  )

UCD_pheno_transplant <- UCD_pheno_transplant %>%
  mutate(across(starts_with("Date"), ~ as.integer(. - planting_date), .names="{.col}_dfp"))
```

#### Visualize bud, flower, and fruit dates

```{r}
ggplot(UCD_pheno_transplant, aes(x=Date_First_Bud, fill=pop)) +
  geom_histogram()

ggplot(UCD_pheno_transplant, aes(x=Date_First_Flower, fill=pop))+
  geom_histogram()

ggplot(UCD_pheno_transplant, aes(x=Date_First_Fruit, fill=pop)) +
  geom_histogram()
```

#### Visualize as bud/flower/fruit day from planting

```{r}
ggplot(UCD_pheno_transplant, aes(x=Date_First_Bud_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Bud")

ggplot(UCD_pheno_transplant, aes(x=Date_First_Flower_dfp, fill=pop))+
  geom_histogram() +
  xlab("Days since planting, Flower")

ggplot(UCD_pheno_transplant, aes(x=Date_First_Fruit_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Fruit")
```

#### Calculate proportions of total planted for each reproductive stage by pop

```{r}
UCD_trans_prop <- UCD_pheno_transplant %>%
  filter(pop != "buffer") %>%
  group_by(pop) %>%
  summarise(
    total_individuals = n(),
    prop_bud = sum(!is.na(Date_First_Bud))/total_individuals,
    prop_flower = sum(!is.na(Date_First_Flower))/total_individuals,
    prop_fruit = sum(!is.na(Date_First_Fruit))/total_individuals
  ) %>%
  pivot_longer(cols=starts_with("prop"),
               names_to="stage",
               values_to="proportion")
```

#### Only include populations with non-zero proportion for bud date

```{r}
UCD_trans_prop_non_zero_bud <- UCD_trans_prop %>%
  filter(stage == "prop_bud" & proportion > 0) %>%
  pull(pop)

UCD_trans_prop_filter <- UCD_trans_prop %>%
  filter(pop %in% UCD_trans_prop_non_zero_bud)
```

#### Visualize proportions

```{r}
ggplot(UCD_trans_prop_filter, aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
#m1 <- glmer(Date_First_Bud ~ 1 + (1|pop),
           # family=gaussian,
           # data=UCD_pheno_transplant)
```

### UCD 2022-2023 Germinants

```{r}
UCD_pheno_germ <- read_csv("../input/UCD_2023_Data/Phenology_survey_germination_20230515_corrected.csv")
```

#### Renaming columns to remove spaces between words and apply lubridate

```{r}
#Update column names
colnames(UCD_pheno_germ)[colnames(UCD_pheno_germ) == "Date First Bud"] <- "Date_First_Bud"
colnames(UCD_pheno_germ)[colnames(UCD_pheno_germ) == "Date First Fruit"] <- "Date_First_Fruit"
colnames(UCD_pheno_germ)[colnames(UCD_pheno_germ) == "Date First Flower"] <- "Date_First_Flower"
colnames(UCD_pheno_germ)[colnames(UCD_pheno_germ) == "Date Last Flower"] <- "Date_Last_Flower"
colnames(UCD_pheno_germ)[colnames(UCD_pheno_germ) == "Date Last Fruit"] <- "Date_Last_Fruit"

#apply lubridate
UCD_pheno_germ$Date_First_Bud <- mdy(UCD_pheno_germ$Date_First_Bud)
UCD_pheno_germ$Date_First_Flower <- mdy(UCD_pheno_germ$Date_First_Flower)
UCD_pheno_germ$Date_First_Fruit <- mdy(UCD_pheno_germ$Date_First_Fruit)
UCD_pheno_germ$Date_Last_Flower <- mdy(UCD_pheno_germ$Date_Last_Flower) #no last flower dates
UCD_pheno_germ$Date_Last_Fruit <- mdy(UCD_pheno_germ$Date_Last_Fruit)
```

#### Change date to days since planting

```{r}
UCD_pheno_germ <- UCD_pheno_germ %>%
  mutate(
    planting_date = mdy("11/27/2022")
  )

UCD_pheno_germ <- UCD_pheno_germ %>%
  mutate(across(starts_with("Date"), ~ as.integer(. - planting_date), .names="{.col}_dfp"))
```

#### Visualize bud, flower, and fruit dates

```{r}
ggplot(UCD_pheno_germ, aes(x=Date_First_Bud, fill=pop)) +
  geom_histogram()

ggplot(UCD_pheno_germ, aes(x=Date_First_Flower, fill=pop)) +
  geom_histogram()

ggplot(UCD_pheno_germ, aes(x=Date_First_Fruit, fill=pop)) +
  geom_histogram()
```

#### Visualize as bud/flower/fruit day from planting

```{r}
ggplot(UCD_pheno_germ, aes(x=Date_First_Bud_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Bud")

ggplot(UCD_pheno_germ, aes(x=Date_First_Flower_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Flower")

ggplot(UCD_pheno_germ, aes(x=Date_First_Fruit_dfp, fill=pop)) +
  geom_histogram() +
   xlab("Days since planting, Fruit")
```

#### Calculate proportion of total planted for each reproductive stage by pop

```{r}
UCD_germ_prop <- UCD_pheno_germ %>%
  group_by(pop) %>%
  summarise(
    total_individuals = n(),
    prop_bud = sum(!is.na(Date_First_Bud))/total_individuals,
    prop_flower = sum(!is.na(Date_First_Flower))/total_individuals,
    prop_fruit = sum(!is.na(Date_First_Fruit))/total_individuals
  ) %>%
  pivot_longer(cols=starts_with("prop"),
               names_to="stage",
               values_to="proportion")
```

#### Visualize proportions

```{r}
ggplot(UCD_germ_prop, aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Visualize proportion for just TM2

```{r}
UCD_germ_prop %>%
  filter(pop == "TM2") %>%
  ggplot(aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### UCD 2023-2024

```{r}
UCD24 <- read_csv("../input/UCD_2023_2024_Data/UCD_mort_pheno_20240908_corrected.csv")

#need to get pop info from uniqueIDs
url <- "https://docs.google.com/spreadsheets/d/1BM5wVLOffxUdHC1yCBJbv3le5hf7Q-WspYVM_nYBiXQ/edit?gid=123887845#gid=123887845"
parent_pop_info <- read_sheet(url, sheet="parent pop labels and germination")

```

#### Add pop column for parent pops using unique.ID

```{r}
UCD24_pop <- UCD24 %>%
  left_join(
    parent_pop_info %>%
      select(unique.ID, pop.id) %>%
      mutate(unique.ID = as.character(unique.ID)),  # Convert unique.ID to character
    by = "unique.ID"
  )
```

#### Apply lubridate

```{r}
UCD24_pop$bud.date <- mdy(UCD24_pop$bud.date)
UCD24_pop$flower.date <- mdy(UCD24_pop$flower.date)
UCD24_pop$fruit.date <- mdy(UCD24_pop$fruit.date)
UCD24_pop$last.FL.date <- mdy(UCD24_pop$last.FL.date)
UCD24_pop$last.FR.date <- mdy(UCD24_pop$last.FR.date)
UCD24_pop$death.date <- mdy(UCD24_pop$death.date)
UCD24_pop$missing.date <- mdy(UCD24_pop$missing.date)

```

#### Fix incorrect dates

```{r}
bud2021 <- UCD24_pop[year(UCD24_pop$bud.date) == 2021,]
print(bud2021)

# Directly update the date of the 2021 entry
UCD24_pop[UCD24_pop$bed == "A" & 
                       UCD24_pop$row == 15 & 
                       UCD24_pop$col == "A", "bud.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "A" & 
                                UCD24_pop$row == 15 & 
                                UCD24_pop$col == "A", "bud.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "A" & 
                             UCD24_pop$row == 15 & 
                             UCD24_pop$col == "A", ])
```

```{r}
bud2014 <- UCD24_pop[year(UCD24_pop$bud.date) == 2014,]
print(bud2014)

# Directly update the date of the 2014 entry
UCD24_pop[UCD24_pop$bed == "C" & 
                       UCD24_pop$row == 35 & 
                       UCD24_pop$col == "D", "bud.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "C" & 
                                UCD24_pop$row == 35 & 
                                UCD24_pop$col == "D", "bud.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "C" & 
                             UCD24_pop$row == 35 & 
                             UCD24_pop$col == "D", ])
```

```{r}
flw2023 <- UCD24_pop[year(UCD24_pop$flower.date) == 2023,]
print(flw2023)

# Directly update the date of the 2023 entry
UCD24_pop[UCD24_pop$bed == "A" & 
                       UCD24_pop$row == 17 & 
                       UCD24_pop$col == "C", "flower.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "A" & 
                                UCD24_pop$row == 17 & 
                                UCD24_pop$col == "C", "flower.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "A" & 
                             UCD24_pop$row == 17 & 
                             UCD24_pop$col == "C", ])

# Directly update the date of the 2023 entry
UCD24_pop[UCD24_pop$bed == "A" & 
                       UCD24_pop$row == 17 & 
                       UCD24_pop$col == "C", "fruit.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "A" & 
                                UCD24_pop$row == 17 & 
                                UCD24_pop$col == "C", "fruit.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "A" & 
                             UCD24_pop$row == 17 & 
                             UCD24_pop$col == "C", ])

```

```{r}
# Directly update the date of the 2014 entry
UCD24_pop[UCD24_pop$bed == "B" & 
                       UCD24_pop$row == 14 & 
                       UCD24_pop$col == "A", "fruit.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "B" & 
                                UCD24_pop$row == 14 & 
                                UCD24_pop$col == "A", "fruit.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "B" & 
                             UCD24_pop$row == 14 & 
                             UCD24_pop$col == "A", ])
```

```{r}
# Directly update the date of the 2014 entry
UCD24_pop[UCD24_pop$bed == "D" & 
                       UCD24_pop$row == 44 & 
                       UCD24_pop$col == "D", "last.FL.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "D" & 
                                UCD24_pop$row == 44 & 
                                UCD24_pop$col == "D", "last.FL.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "D" & 
                             UCD24_pop$row == 44 & 
                             UCD24_pop$col == "D", ])
```

```{r}
#CHECK THIS ONE, LAST FR DATE BEFORE LAST FLOWER DATE!!!! - corrected
#unique.ID 246
#Checked pdf and confirmed last FR date should be 05/31/2024

# Directly update the date of the 2014 entry
UCD24_pop[UCD24_pop$bed == "F" & 
                       UCD24_pop$row == 33 & 
                       UCD24_pop$col == "C", "last.FR.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "F" & 
                                UCD24_pop$row == 33 & 
                                UCD24_pop$col == "C", "last.FR.date"][[1]], 
         year = 2024, day = 31)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "F" & 
                             UCD24_pop$row == 33 & 
                             UCD24_pop$col == "C", ])

```

```{r}
# Directly update the date of the 2014 entry
UCD24_pop[UCD24_pop$bed == "C" & 
                       UCD24_pop$row == 31 & 
                       UCD24_pop$col == "C", "last.FR.date"] <- 
  update(UCD24_pop[UCD24_pop$bed == "C" & 
                                UCD24_pop$row == 31 & 
                                UCD24_pop$col == "C", "last.FR.date"][[1]], 
         year = 2024)

# Verify the updated date
print(UCD24_pop[UCD24_pop$bed == "C" & 
                             UCD24_pop$row == 31 & 
                             UCD24_pop$col == "C", ])
```

#### Change date to days since planting

```{r}
planting_date <- mdy("12/04/2023")

UCD24_pop <- UCD24_pop %>%
  mutate(across(ends_with(".date") & !matches("census.date"),
                ~ as.integer(ymd(.) - planting_date),
                .names="{.col}_dfp"))
```

#### Visualize with date of stage

```{r}
UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=bud.date, fill=pop.id)) +
  geom_histogram()

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=flower.date, fill=pop.id)) +
  geom_histogram()

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=fruit.date, fill=pop.id)) +
  geom_histogram()

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=last.FL.date, fill=pop.id)) +
  geom_histogram()

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=last.FR.date, fill=pop.id)) +
  geom_histogram()

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=death.date, fill=pop.id)) +
  geom_histogram()
```

#### Visualize with day since planting

```{r}
UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=bud.date_dfp, fill=pop.id)) +
  geom_histogram() +
  xlab("Days since planting, Bud")

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=flower.date_dfp, fill=pop.id)) +
  geom_histogram() +
  xlab("Days since planting, Flower")

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=fruit.date_dfp, fill=pop.id)) +
  geom_histogram() +
  xlab("Days since planting, Fruit")

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=last.FL.date_dfp, fill=pop.id)) +
  geom_histogram() +
  xlab("Days since planting, Last Flower")

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=last.FR.date_dfp, fill=pop.id)) +
  geom_histogram() +
  xlab("Days since planting, Last Fruit")

UCD24_pop %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=death.date_dfp, fill=pop.id)) +
  geom_histogram()
```

#### Calculate proportions

```{r}
UCD_24_proportion <- UCD24_pop %>%
  group_by(pop.id) %>%
  summarise(
    total_individuals = n(),
    prop_bud = sum(!is.na(bud.date))/total_individuals,
    prop_flower = sum(!is.na(flower.date))/total_individuals,
    prop_fruit = sum(!is.na(fruit.date))/total_individuals
  ) %>%
  pivot_longer(cols=starts_with("prop"),
               names_to="stage",
               values_to="proportion")
```

#### Visualize proportions

```{r}
UCD_24_proportion %>%
  filter(!is.na(pop.id)) %>%
  ggplot(aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop.id, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Initiate repro by pop

```{r}
UCD_24_model <- UCD24_pop%>%
  filter(!is.na(pop.id)) %>%
  mutate(initiate_repro = if_else(!is.na(bud.date_dfp), 1, 0))
```

```{r}
m2 <- glm(initiate_repro ~ pop.id,
    data= UCD_24_model,
    family = binomial())
summary(m2)

m3 <- glm(initiate_repro ~ 1,
    data= UCD_24_model,
    family = binomial())

lrtest(m3,m2)

plogis(coef(m2))
```

```{r}
m4 <- glmer(initiate_repro ~ (1 | pop.id),
            data=UCD_24_model,
            family=binomial)
summary(m4)
```

### WL2 2023

```{r}
WL2_pheno <- read_csv("../input/WL2_2023_Data/WL2_mort_pheno_20231020_corrected.csv")
```

#### Apply lubridate

```{r}
#apply lubridate
WL2_pheno$bud.date <- mdy(WL2_pheno$bud.date)
WL2_pheno$flower.date <- mdy(WL2_pheno$flower.date)
WL2_pheno$fruit.date <- mdy(WL2_pheno$fruit.date)
WL2_pheno$last.flower.date <- mdy(WL2_pheno$last.flower.date)
WL2_pheno$last.fruit.date <- mdy(WL2_pheno$last.fruit.date)
WL2_pheno$death.date <- mdy(WL2_pheno$death.date)
```

#### Filter to only include individuals that budded - don't think I want this

```{r}
#WL2_pheno_filter <- WL2_pheno[!is.na(WL2_pheno$bud.date),]
```

#### One individual has the wrong fruit date year, correct to say 2023

```{r}
#one of the fruit dates says 2013
fruit2014 <- WL2_pheno[year(WL2_pheno$fruit.date) == 2013,]
print(fruit2014)

# Directly update the date of the 2013 entry
WL2_pheno[WL2_pheno$block == "A" & 
                       WL2_pheno$bed == "A" & 
                       WL2_pheno$bed.row == 23 & WL2_pheno$bed.col == "D", "fruit.date"] <- 
  update(WL2_pheno[WL2_pheno$block == "A" & 
                       WL2_pheno$bed == "A" & 
                       WL2_pheno$bed.row == 23 & WL2_pheno$bed.col == "D", "fruit.date"][[1]], year = 2023)

# Verify the updated date
print(WL2_pheno[WL2_pheno$block == "A" & 
                       WL2_pheno$bed == "A" & 
                       WL2_pheno$bed.row == 23 & WL2_pheno$bed.col == "D", ])
```

```{r}
#THIS PLANTING IS HARDER TO ASSIGN A PLANTING DAY SINCE IT IS DONE BY BLOCK
#For now I will call the planting date the day when all the plants were in
WL2_23_planting_date <- mdy("07/19/2023")

WL2_pheno <- WL2_pheno %>%
  mutate(across(ends_with(".date"),
                ~ as.integer(ymd(.) - planting_date),
                .names="{.col}_dfp"))
```

#### Visualize bud, flower, and fruit dates

```{r}
ggplot(WL2_pheno, aes(x=bud.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_pheno, aes(x=flower.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_pheno, aes(x=fruit.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_pheno, aes(x=death.date, fill=pop)) +
  geom_histogram()
```

```{r}
ggplot(WL2_pheno, aes(x=bud.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Bud")

ggplot(WL2_pheno, aes(x=flower.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Flower")

ggplot(WL2_pheno, aes(x=fruit.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Fruit")

ggplot(WL2_pheno, aes(x=death.date_dfp, fill=pop)) +
  geom_histogram()
```

#### Calculate proportion

```{r}
WL2_pheno_proportion <- WL2_pheno %>%
  group_by(pop) %>%
  summarise(
    total_individuals = n(),
    prop_bud = sum(!is.na(bud.date))/total_individuals,
    prop_flower = sum(!is.na(flower.date))/total_individuals,
    prop_fruit = sum(!is.na(fruit.date))/total_individuals
  ) %>%
  pivot_longer(cols=starts_with("prop"),
               names_to="stage",
               values_to="proportion")
```

#### Visualize proportions

```{r}
ggplot(WL2_pheno_proportion, aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Phenological Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
WL2_pheno_proportion %>%
  filter(pop == "TM2" | pop == "FR") %>%
  ggplot(aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
```

### WL2 2024

```{r}
WL2_24 <- read_csv("../input/WL2_2024_Data/WL2_mort_pheno_20241023_corrected.csv")

```

```{r}
#apply lubridate
WL2_24$bud.date <- mdy(WL2_24$bud.date)
WL2_24$flower.date <- mdy(WL2_24$flower.date)
WL2_24$fruit.date <- mdy(WL2_24$fruit.date)
WL2_24$last.FL.date <- mdy(WL2_24$last.FL.date)
WL2_24$last.FR.date <- mdy(WL2_24$last.FR.date)
WL2_24$death.date <- mdy(WL2_24$death.date)
WL2_24$missing.date <- mdy(WL2_24$missing.date)
```

```{r}
#creating column with only pop info
WL2_24_pop <- WL2_24 %>%
  mutate(pop = case_when(
    grepl("^\\w+_\\d+_\\d+$", unique.ID) ~ sub("^(\\w+)_\\d+_\\d+$", "\\1", unique.ID),
    TRUE ~ unique.ID
  ))
```

```{r}
WL2_24_pop <- WL2_24_pop %>%
  mutate(
    planting_date = if_else(is.na(block), WL2_23_planting_date, NA_Date_)
  ) %>%
  mutate(across(
    ends_with(".date"),  
    ~ if_else(is.na(block), as.integer(ymd(.) - WL2_23_planting_date), NA_integer_),  
    .names = "{.col}_dfp"  
  ))
```

```{r}
ggplot(WL2_24_pop, aes(x=bud.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_24_pop, aes(x=flower.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_24_pop, aes(x=fruit.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_24_pop, aes(x=last.FL.date, fill=pop)) +
  geom_histogram()

ggplot(WL2_24_pop, aes(x=last.FR.date, fill=pop)) +
  geom_histogram()

#ggplot(WL2_24_pop, aes(x=death.date, fill=pop)) +
  #geom_histogram()
```

```{r}
ggplot(WL2_24_pop, aes(x=bud.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Bud")

ggplot(WL2_24_pop, aes(x=flower.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Flower")

ggplot(WL2_24_pop, aes(x=fruit.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Fruit")

ggplot(WL2_24_pop, aes(x=last.FL.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Last Flower")

ggplot(WL2_24_pop, aes(x=last.FR.date_dfp, fill=pop)) +
  geom_histogram() +
  xlab("Days since planting, Last Fruit")

#ggplot(WL2_24_pop, aes(x=death.date_dfp, fill=pop)) +
  #geom_histogram()
```

```{r}
WL2_24_proportion <- WL2_24_pop %>%
  group_by(pop) %>%
  summarise(
    total_individuals = n(),
    prop_bud = sum(!is.na(bud.date))/total_individuals,
    prop_flower = sum(!is.na(flower.date))/total_individuals,
    prop_fruit = sum(!is.na(fruit.date))/total_individuals
  ) %>%
  pivot_longer(cols=starts_with("prop"),
               names_to="stage",
               values_to="proportion")
```

```{r}
#only inlcude parent pops?
WL2_24_prop_parent <- WL2_24_proportion %>%
  filter(grepl("^[A-Z]+[0-9]*$", pop) & pop != "buffer")
```

```{r}
#only include populations with non-zero proportion for bud date
#WL2_24_prop_non_zero_bud <- WL2_24_proportion %>%
 # filter(stage == "prop_bud" & proportion > 0) %>%
 # pull(pop)

#WL2_24_prop_filter <- WL2_24_proportion %>%
  #filter(pop %in% WL2_24_prop_non_zero_bud)
```

```{r}
ggplot(WL2_24_prop_parent, aes(x=stage, y=proportion, fill=stage)) + 
  geom_bar(stat="identity", show.legend=FALSE) +
  geom_text(aes(label=paste0("Total: ", total_individuals)),
            position = position_stack(vjust = 1.1), size = 2, color = "black") +
  facet_wrap(~pop, ncol = 4) +
  labs(x="Reproductive Stage", y="Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

#### Initiate reproduction by pop

```{r}
WL2_24_model <- WL2_24_pop %>%
  filter(grepl("^[A-Z]+[0-9]*$", pop) & pop != "buffer") %>%
  mutate(initiate_repro = if_else(!is.na(bud.date_dfp), 1, 0))
```

```{r}
m1 <- glm(initiate_repro ~ pop,
    data=WL2_24_model,
    family = binomial())
summary(m1)

m0 <- glm(initiate_repro ~ 1,
    data=WL2_24_model,
    family = binomial())

lrtest(m0,m1)

plogis(coef(m1))
```

```{r}
m5 <- glmer(initiate_repro ~ (1|pop),
            data=WL2_24_model,
            family=binomial)

summary(m5)
```

Likelihood of flowering given budding
